<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>語音識別與分類</title>
</head>
<body>

    <h2>語音輸入分類系統</h2>
    <button id="start">開始語音輸入</button>
    <button id="pause" disabled>暫停語音識別</button>
    <input type="text" id="text-input" placeholder="說點什麼..." readonly>
    <p id="category">分類結果：</p> <!-- 顯示分類結果 -->

    <script>
        const categoryOutput = document.getElementById('category');
        const textInput = document.getElementById('text-input');
        const startBtn = document.getElementById('start');
        const pauseBtn = document.getElementById('pause');

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("你的瀏覽器不支援語音識別！");
        }

        const recognition = new SpeechRecognition();
        recognition.lang = "zh-TW"; // 設定語言為繁體中文
        recognition.continuous = false; // 設定為非連續模式（一次辨識完畢後就停止）

        recognition.onstart = function() {
            console.log("語音識別已啟動...");
            startBtn.disabled = true;
            pauseBtn.disabled = false;
        };

        recognition.onend = function() {
            console.log("語音識別已結束");
            startBtn.disabled = false;
            pauseBtn.disabled = true;
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            textInput.value = transcript;
            sendVoiceToBackend(transcript); // 發送語音結果到後端
        };

        function sendVoiceToBackend(transcript) {
            console.log("準備發送語音內容到後端:", transcript);
        
            fetch('/voice/upload/', {
                method: 'POST', // 確保是 POST
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ voice_input: transcript })  // 傳送 JSON 格式的資料
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(`HTTP ${response.status}: ${text}`); });
                }
                return response.json();  // 確保解析 JSON
            })
            .then(data => {
                console.log("後端回應:", data);
        
                // **顯示分類結果**
                const categoryOutput = document.getElementById('category');
                if (categoryOutput) {
                    categoryOutput.innerText = `分類結果: ${data.category || '未知'}`;
                }
            })
            .catch(error => {
                console.error('發送語音資料至後端時發生錯誤:', error);
                alert('發送語音資料至後端時發生錯誤，請稍後再試。');
            });
        }
        
        
        startBtn.addEventListener('click', function() {
            recognition.start();
        });

        pauseBtn.addEventListener('click', function() {
            recognition.stop();
        });

    </script>

</body>
</html>
